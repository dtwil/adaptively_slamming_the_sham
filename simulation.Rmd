```{r}
chicks <- read.table("chickens.dat", header = TRUE)
J <- nrow(chicks)
x <- chicks$freq
y0 <- chicks$sham_est - 1
se0 <- chicks$sham_se
n0 <- chicks$sham_n
y1 <- chicks$exposed_est - 1
se1 <- chicks$exposed_se
n1 <- chicks$exposed_n
diff <- y1 - y0
diff_se <- sqrt(se1 ^ 2 + se0 ^ 2)
```

```{r}
library("rstan")
y <- c(y0, y1)
se <- c(se0, se1)
expt_id <- rep(1:J, 2)
z <- c(rep(0, J), rep(1, J))  # treatment:  0 = sham, 1 = exposed
chick_data <- list(
  N = 2 * J,
  J = J,
  y = y,
  se = se,
  x = x,
  expt_id = expt_id,
  z = z,
  diff = diff,
  diff_se = diff_se
)
```

```{r}
## Fit a hierarchical model
fit_hier <-
  stan(
    "chickens-no-corr-hier.stan",
    data = chick_data,
    control = list(adapt_delta = 0.9),
    refresh = 0
  )
```

```{r}
theta <- extract(fit_hier)$theta
theta_hat <- apply(theta, 2, mean)
theta_se <- apply(theta, 2, sd)
```

The function below simulates a dataset for `num_experiments` experiments. Here one complication is that the original simulation assumes all experiments have the same number of subjects in the control and treatment groups.

The original assumptions are:

$$
\begin{align*}
y_{j1} &\sim N(\theta_j + b_j, s_{j1}) \\
y_{j0} &\sim N(b_j, s_{j0}) \\
\theta_j &\sim N(\mu_\theta, \sigma_\theta) \\
b_j &\sim N(\mu_b, \sigma_b)
\end{align*}
$$

In the original simulation, it was assumed that $s_{j1} = s_{j0} = 0.04$ for all $j$. This is reasonable if the treatment and control groups have the same size and if we expect the treatment/sham effects to have similar spread, which was empirically shown for the chicken dataset. 

However, if the groups have unequal numbers of subjects, then we expect the group with fewer subjects to have higher variance. We let $Y_{j0}^{(i)}$ and $Y_{j1}^{(k)}$ be the outcomes for the $i$th and $k$th individuals in the control and treatment groups respectively for experiment $j$. Let the $j$th experiment have $N_{j0}$ and $N_{j1}$ subjects in control and treatment groups respectively. If the number of subjects in each group is at least 30, then by the CLT we have

$$ y_{j1} = \frac{1}{N_{j1}} \sum_{k=1}^{N_{j1}} Y_{j1}^{(k)} \rightarrow N(\mu_{j1}, \sigma_{j1}) $$

where $\sigma_{j1} = \sqrt{\frac{\text{var}(Y_{j1}^{(k)})}{N_{j1}}}$ and similarly for $y_{j0}$. We identify $\mu_{j1}$ with $\theta_j + b_j$ and $\sigma_{j1}$ with $s_{j1}$. Since $s_{j1} = 0.04$ in the original simulation, we use $\text{var}(Y_{j1}^{(k)}) = 32 \times (0.04)^2$ for all experiments $j$ and individuals $k$; likewise for $\text{var}(Y_{j0}^{(i)})$.

*Thought: What if the sample sizes are too small for the CLT? Maybe bootstrap or make distributional assumptions on $Y_{j1}^{(k)}$?*

```{r}
#' Return a simulated dataset. Note that sigma_treatment and sigma_baseline
#' are standard deviations for the INDIVIDUAL treatment/sham effects.
#'
#' @param num_experiments The number of experiments to simulate
#' @param num_subjects Vector of the number of subjects in each experiment
#' @param prop_treatment Vector of the proportion of subjects in each experiment that are treated
#' @param true_theta The true treatment effect
#' @param true_b The true baseline effect
#' @param sigma_treatment The standard deviation of the outcome
#' @param sigma_baseline The standard deviation of the baseline effect
simulate_experiments <- function(
    num_experiments,
    num_subjects,
    prop_treatment,
    true_b,
    true_theta,
    sigma_b,
    sigma_theta,
    sigma_treatment,
    sigma_control) { 
    num_treated <- floor(prop_treatment * num_subjects)
    num_control <- num_subjects - num_treated

    sigma_y0 <- sigma_control / sqrt(num_control)
    sigma_y1 <- sigma_treatment / sqrt(num_treated)

    b <- rnorm(num_experiments, true_b, sigma_b)
    theta <- rnorm(num_experiments, true_theta, sigma_theta)
    y_control <- rnorm(num_experiments, b, sigma_y0)
    y_treated <- rnorm(num_experiments, theta + b, sigma_y1)

    data <- list(
        N = 2 * num_experiments,
        J = num_experiments,
        P = prop_treatment,
        y = c(y_control, y_treated),
        se = c(sigma_y0, sigma_y1),
        x = rep(1, num_experiments),
        expt_id = rep(1:num_experiments, 2),
        z = c(rep(0, num_experiments), rep(1, num_experiments))
    )
    return(data)
}
```

```{r}
estimate_parameters <- function(data, model_path) {
    fit <- stan(
        model_path,
        data = data,
        control = list(adapt_delta = 0.9),
        refresh = 0
    )
    theta <- extract(fit)$theta
    theta_hat <- apply(theta, 2, mean)
    theta_se <- apply(theta, 2, sd)

    b <- extract(fit)$b
    b_hat <- apply(b, 2, mean)
    b_se <- apply(b, 2, sd)

    parameter_estimates <- list(
        theta = theta,
        theta_hat = theta_hat,
        theta_se = theta_se,
        mu_theta = extract(fit)$mu_theta,
        b = b,
        b_hat = b_hat,
        b_se = b_se,
        mu_b = extract(fit)$mu_b
    )
    return(parameter_estimates)
}
```

```{r}
chick_model_path <- "chickens-no-corr-hier.stan"
chick_params <- estimate_parameters(chick_data, chick_model_path)
```

```{r}
num_blocks <- 2
num_exps_per_block <- 19
prop_treatment <- c(rep(0.5, num_exps_per_block), rep(0.90, num_exps_per_block))
num_subjects <- c(rep(64, num_exps_per_block), rep(64, num_exps_per_block))

sim_data <- simulate_experiments(
    num_experiments = num_blocks * num_exps_per_block,
    num_subjects = num_subjects,
    prop_treatment = prop_treatment,
    true_b = 0,
    true_theta = chick_params$mu_theta,
    sigma_b = mean(chick_params$b_se),
    sigma_theta = 0,
    sigma_treatment = 32 * 0.04^2,
    sigma_control = 32 * 0.04^2
)
```

```{r}
sim_params <- estimate_parameters(sim_data, chick_model_path)
```

```{r}
library(ggplot2)

# Create a data frame for plotting
plot_data <- data.frame(
  b_se = sim_params$b_se,
  prop_treatment = sim_data$P
)

# Create the plot
ggplot(plot_data, aes(x = prop_treatment, y = b_se, color = as.factor(prop_treatment))) + 
  geom_point() + 
  labs(
    title = "Standard Errors of Baseline Effects by Proportion of Treatment",
    x = "Proportion of Treatment",
    y = "Standard Error of Baseline Effect",
    color = "Proportion of Treatment"
  ) + 
  theme_minimal()
```